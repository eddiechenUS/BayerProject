<?xml version="1.0" encoding="UTF-8"?>
<Entities
 build="b222"
 majorVersion="8"
 minorVersion="5"
 modelPersistenceProviderPackage="PostgresPersistenceProviderPackage"
 revision="4"
 schemaVersion="1053"
 universal="">
    <ThingShapes>
        <ThingShape
         className=""
         description="Implemented on BayerProductionLine"
         documentationContent=""
         homeMashup=""
         lastModifiedDate="2021-06-16T01:25:25.795Z"
         name="BayerProductionManagement"
         projectName="BayerIoT"
         tags="Applications:Bayer">
            <PropertyDefinitions>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeThreshold="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.defaultValue="0.0"
                 aspect.isLogged="false"
                 aspect.isPersistent="true"
                 aspect.isReadOnly="false"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="counter"
                 ordinal="2"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.isLogged="false"
                 aspect.isPersistent="true"
                 aspect.isReadOnly="false"
                 baseType="INTEGER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="currentProductKey"
                 ordinal="4"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeThreshold="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.defaultValue="0.0"
                 aspect.isLogged="false"
                 aspect.isPersistent="true"
                 aspect.isReadOnly="false"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="kepwareCounter"
                 ordinal="1"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.isPersistent="true"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="kepwareRejectCounter"
                 ordinal="11"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.isPersistent="true"
                 baseType="DATETIME"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="lastProductionPlanUpdate"
                 ordinal="7"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeThreshold="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.defaultValue="0.0"
                 aspect.isLogged="false"
                 aspect.isPersistent="true"
                 aspect.isReadOnly="false"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="previousProductCounter"
                 ordinal="3"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.isPersistent="true"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="previousProductRejectCounter"
                 ordinal="12"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 baseType="STRING"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="productionlinestatus"
                 ordinal="8"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.isPersistent="true"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="productionsensorvalue"
                 ordinal="9"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.defaultValue="0.0"
                 aspect.isPersistent="true"
                 baseType="NUMBER"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="rejectCounter"
                 ordinal="10"></PropertyDefinition>
                <PropertyDefinition
                 aspect.cacheTime="0.0"
                 aspect.dataChangeType="VALUE"
                 aspect.defaultValue="false"
                 aspect.isLogged="false"
                 aspect.isPersistent="false"
                 aspect.isReadOnly="false"
                 baseType="BOOLEAN"
                 category="Production"
                 description=""
                 isLocalOnly="false"
                 name="updateProductLock"
                 ordinal="6"></PropertyDefinition>
            </PropertyDefinitions>
            <ServiceDefinitions>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="CompleteCurrentProduct">
                    <ResultType
                     baseType="NOTHING"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         baseType="STRING"
                         description=""
                         name="commentsOnEditedQuantity"
                         ordinal="2"></FieldDefinition>
                        <FieldDefinition
                         aspect.minimumValue="0"
                         baseType="INTEGER"
                         description=""
                         name="editedQuantity"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetChangeoverDetailsTrendForLine">
                    <ResultType
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="DATETIME"
                         description=""
                         name="dateTime"
                         ordinal="1"></FieldDefinition>
                        <FieldDefinition
                         aspect.defaultValue="0"
                         aspect.isRequired="true"
                         aspect.maximumValue="0"
                         aspect.minimumValue="-5"
                         aspect.units="week"
                         baseType="INTEGER"
                         description=""
                         name="week"
                         ordinal="2"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Changeover"
                 description="Get Changeover Split Times as Info Table"
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetChangeoverSplitTimes">
                    <ResultType
                     aspect.dataShape="BayerChangeoverSplitTimeValue"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions></ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetChangeoverTime">
                    <ResultType
                     aspect.dataShape="BayerProgressDisplayDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions></ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetChangeoverTimes">
                    <ResultType
                     aspect.dataShape="BayerChangeoverTimesDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="DATETIME"
                         description=""
                         name="endTime"
                         ordinal="2"></FieldDefinition>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="DATETIME"
                         description=""
                         name="startTime"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetChangeoverTrendByDate">
                    <ResultType
                     aspect.dataShape="BayerChangeoverTrendDetailsDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         baseType="DATETIME"
                         description=""
                         name="endDate"
                         ordinal="2"></FieldDefinition>
                        <FieldDefinition
                         baseType="DATETIME"
                         description=""
                         name="startDate"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetChangeoverTrendForLine">
                    <ResultType
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="DATETIME"
                         description=""
                         name="dateTime"
                         ordinal="1"></FieldDefinition>
                        <FieldDefinition
                         aspect.defaultValue="0"
                         aspect.maximumValue="0"
                         aspect.minimumValue="-5"
                         aspect.units="week"
                         baseType="INTEGER"
                         description=""
                         name="week"
                         ordinal="3"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetCurrentProduct">
                    <ResultType
                     aspect.dataShape="BayerProductionPlanDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions></ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetMaintenanceTicketsByDate">
                    <ResultType
                     aspect.dataShape="BayerMaintenanceTicketsDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         baseType="DATETIME"
                         description=""
                         name="endDate"
                         ordinal="2"></FieldDefinition>
                        <FieldDefinition
                         baseType="DATETIME"
                         description=""
                         name="startDate"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="GetProductionPlan">
                    <ResultType
                     aspect.dataShape="BayerProductionPlanDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions></ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="InsertStandbyBelow">
                    <ResultType
                     aspect.dataShape="BayerProductionPlanDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="INTEGER"
                         description="Stanby item will be inserted after this input production plan item. "
                         name="afterProductionId"
                         ordinal="1"></FieldDefinition>
                        <FieldDefinition
                         baseType="NUMBER"
                         description=""
                         name="targetHours"
                         ordinal="2"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category=""
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="LoadCSVv2">
                    <ResultType
                     aspect.dataShape="BayerProductionPlanDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="STRING"
                         description=""
                         name="path"
                         ordinal="1"></FieldDefinition>
                        <FieldDefinition
                         aspect.isRequired="true"
                         aspect.thingTemplate="FileRepository"
                         baseType="THINGNAME"
                         description=""
                         name="repository"
                         ordinal="2"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="true"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="LoadProductionPlan">
                    <ResultType
                     aspect.dataShape="BayerProductionPlanDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.isRequired="true"
                         baseType="INFOTABLE"
                         description=""
                         name="data"
                         ordinal="1"></FieldDefinition>
                        <FieldDefinition
                         baseType="BOOLEAN"
                         description=""
                         name="simulate"
                         ordinal="2"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Changeover"
                 description="Recalculate Plan Changeovers"
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="RecalculatePlanChangeovers">
                    <ResultType
                     aspect.dataShape="BayerProductionPlanDataShape"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.defaultValue="false"
                         baseType="BOOLEAN"
                         description="Should simulate?"
                         name="simulate"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Changeover"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="SetChangeoverSplitTimes">
                    <ResultType
                     aspect.dataShape="BayerChangeoversSplitTimeDelays"
                     baseType="INFOTABLE"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.dataShape="BayerChangeoverSplitTimeValue"
                         baseType="INFOTABLE"
                         description="Changeover Split Times"
                         name="splitTimes"
                         ordinal="1"></FieldDefinition>
                        <FieldDefinition
                         aspect.defaultValue="true"
                         baseType="BOOLEAN"
                         description=""
                         name="updateTable"
                         ordinal="2"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="UpdateCounter">
                    <ResultType
                     baseType="NOTHING"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.dataShape="DataChangeEvent"
                         aspect.isRequired="true"
                         baseType="INFOTABLE"
                         description=""
                         name="eventData"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="true"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="UpdateProduct">
                    <ResultType
                     baseType="NOTHING"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.dataShape="ScheduledEvent"
                         aspect.isRequired="true"
                         baseType="INFOTABLE"
                         description=""
                         name="eventData"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
                <ServiceDefinition
                 aspect.isAsync="false"
                 category="Production"
                 description=""
                 isAllowOverride="false"
                 isLocalOnly="false"
                 isOpen="false"
                 isPrivate="false"
                 name="UpdateRejectCounter">
                    <ResultType
                     baseType="NOTHING"
                     description=""
                     name="result"
                     ordinal="0"></ResultType>
                    <ParameterDefinitions>
                        <FieldDefinition
                         aspect.dataShape="DataChangeEvent"
                         baseType="INFOTABLE"
                         description=""
                         name="eventData"
                         ordinal="1"></FieldDefinition>
                    </ParameterDefinitions>
                </ServiceDefinition>
            </ServiceDefinitions>
            <EventDefinitions></EventDefinitions>
            <ServiceMappings></ServiceMappings>
            <ServiceImplementations>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="CompleteCurrentProduct">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // CompleteCurrentProduct service
                                    // * editedQuantity - INTEGER
                                    // * commentsOnEditedQuantity - STRING
                                    
                                    // complete current in progress product
                                    try {
                                        me.updateProductLock = true; // to block the periodic "UpdateProduct" task
                                        let lineConfiguration = me.GetLineConfiguration();
                                        let allowAdjustment = lineConfiguration.rows[0].allowManualAdjustment;
                                        //throw test;
                                        // result: INFOTABLE dataShape: "BayerProductionPlanDataShape"
                                        var current = me.GetCurrentProduct();
                                        var currentQuantity = me.counter;
                                        if (current && current.rows.length > 0) {
                                            current.producedQuantity = currentQuantity;
                                            if (allowAdjustment && (editedQuantity != undefined && editedQuantity > 0)) {
                                                current.producedQuantity = editedQuantity;
                                    
                                                // inserting changed quantity and comments if manually adjusted
                                                Things["BayerDBDataProvider"].InsertProductionQuantityChange({
                                                    productionPlanId: current.id /* INTEGER */,
                                                    originalTargetQuantity: currentQuantity /* NUMBER */,
                                                    commentAdded: commentsOnEditedQuantity /* STRING */,
                                                    targetQuantity: editedQuantity /* NUMBER */
                                                });
                                            }
                                            me.previousProductCounter += me.counter;
                                            me.previousCycleCounter -= me.counter;
                                            me.counter = 0;
                                    
                                            current.status = "COMPLETED";
                                            current.endTime = new Date();
                                    
                                            var difference = dateDifference(current.endTime, current.startTime);
                                    
                                            current.workedHours = difference / 1000.0 / 60.0 / 60.0;
                                            current.remainingHours = current.targetHours - current.workedHours;
                                            if (current.remainingHours < 0) {
                                                current.remainingHours = 0;
                                            }
                                    
                                            Things["BayerDBDataProvider"].UpdateProductionPlanOnCompletion({
                                                data: current /* INFOTABLE */
                                            });
                                        }
                                        // start first pending product
                                        // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                        var pending = Things["BayerDBDataProvider"].GetProductionPlanItemByStatus({
                                            productionLine: me.name /* THINGNAME */,
                                            status: 'PENDING' /* STRING */
                                        });
                                    
                                        if (!!pending && !!pending.rows.length) {
                                            me.currentProductKey = pending.id;
                                    
                                            pending.startTime = new Date();
                                            pending.status = "INPROGRESS";
                                    
                                            Things["BayerDBDataProvider"].UpdateProductionPlanOnStart({
                                                data: pending /* INFOTABLE */
                                            });
                                        }
                                    } catch (ex) {
                                        logger.error(me.name + ".CompleteCurrentProduct " + ex + " " + ex.stack);
                                        throw ex;
                                    } finally {
                                        me.updateProductLock = false;
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetChangeoverDetailsTrendForLine">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var result = Things["BayerDBDataProvider"].GetChangeoverDetailsTrendForLine({
                                    	productionLine: me.name,
                                        dateTime: dateTime,
                                        week: week,
                                    });
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetChangeoverSplitTimes">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // GetChangeoverSplitTimes service
                                    
                                    var splitTimes = me.GetConfigurationTable({ tableName: "Changeover_SplitTimes" });
                                    var output2 = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                    	infoTableName: "result" /* STRING */,
                                    	dataShapeName: "BayerChangeoverSplitTimeValue" /* DATASHAPENAME */
                                    });
                                    var result = output2;
                                    //var values = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                    //	dataShapeName: "BayerChangeoversSplitTimeDelays"
                                    //});
                                    var fieldList = [];
                                    var fieldListIT = DataShapes["BayerChangeoversSplitTimeDelays"].GetFieldDefinitions();
                                    for (let fidx = 0; fidx < fieldListIT.rows.length; fidx++) {
                                    	fieldList.push(fieldListIT.rows[fidx].name);
                                    } //# for each field row
                                    
                                    /*var fieldList = [
                                    	"orderChange",
                                    	"productChange",
                                    	"blisterTypeChange",
                                    	"groundFoilChange",
                                    	"blisterSizeChange",
                                    	"boxFormatChange",
                                    	"blisterAmountChange",
                                    	"bundleFormatChange"
                                    ];*/
                                    /*[
                                    	"Bayer.OrderChange",
                                    	"Bayer.ProductChange",
                                    	"Bayer.BlisterTypeChange",
                                    	"Bayer.GroundFoilChange",
                                    	"Bayer.BlisterSizeChange",
                                    	"Bayer.BoxFormatChange",
                                    	"Bayer.BlisterAmountChange",
                                    	"Bayer.BundleFormatChange"
                                    ];*/
                                    
                                    splitTimes = splitTimes.rows[0];
                                    var localization = Resources["RuntimeLocalizationFunctions"];
                                    for (let idx = 0; idx < fieldList.length; idx++) {
                                    	let fieldName = fieldList[idx];
                                    	let token = "Bayer." + fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
                                    	let tokenValue = localization.GetEffectiveToken({ token: token });
                                    
                                    	result.AddRow({
                                    		fieldName: fieldName,
                                    		description: tokenValue,
                                    		value: splitTimes[fieldName]
                                    	});
                                    } //# for each field to convert
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetChangeoverTime">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // GetChangeoverTime service
                                    
                                    // CreateInfoTableFromDataShape(infoTableName:STRING("InfoTable")
                                    // dataShapeName:STRING):INFOTABLE(BayerProgressDisplayDataShape)
                                    var result = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                        dataShapeName: "BayerProgressDisplayDataShape"
                                    });
                                    // BayerProgressDisplayDataShape entry object
                                    var newEntry = {};
                                    newEntry.min = 0; // NUMBER
                                    
                                    // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                    var currentProduct = me.GetCurrentProduct();
                                    if (currentProduct && currentProduct.getRowCount() > 0) {
                                        if (currentProduct.productId == "Cambio") {
                                            var targetMinutes = currentProduct.targetHours * 60;
                                    
                                            // dateDifference(date1:DATETIME,date2:DATETIME):NUMBER
                                            var difference = dateDifference(new Date(), currentProduct.startTime) / 1000 / 60;
                                    
                                            newEntry.max = targetMinutes; // NUMBER
                                            newEntry.value = difference; // NUMBER
                                    
                                            // #FIXME
                                            //newEntry.value = targetMinutes - 10;
                                    
                                            // Bayer wants to be able to exceed the target by 10%
                                            newEntry.green = difference < targetMinutes * 1.1;
                                            newEntry.red = !newEntry.green;
                                        } else {
                                            newEntry.max = 60; // NUMBER
                                            newEntry.value = 0; // NUMBER
                                            newEntry.green = true;
                                            newEntry.red = false;
                                        }
                                    } else {
                                        newEntry.red = false; // BOOLEAN
                                        newEntry.green = false; // BOOLEAN
                                        newEntry.max = 60; // NUMBER
                                        newEntry.value = 0; // NUMBER
                                    }
                                    result.AddRow(newEntry);
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetChangeoverTimes">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // GetChangeoverTimes service
                                    // * startTime - DATETIME
                                    // * endTime - DATETIME
                                    
                                    // changeovers finished after startTime and started before endTime
                                    // plus changeover in progress
                                    // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                    var filtered = Things["BayerDBDataProvider"].GetChangeovers({
                                        productionLine: me.name /* THINGNAME */,
                                        startTime: startTime /* DATETIME */,
                                        endTime: endTime /* DATETIME */
                                    });
                                    // BUILDING RESULT
                                    var currentTime = new Date();
                                    // CreateInfoTableFromDataShape(infoTableName:STRING("InfoTable"), dataShapeName:STRING):INFOTABLE(BayerChangeoverTimesDataShape)
                                    var result = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                        infoTableName: "InfoTable",
                                        dataShapeName: "BayerChangeoverTimesDataShape"
                                    });
                                    var tableLength = filtered.rows.length;
                                    for (let idx = 0; idx < tableLength; idx++) {
                                        let row = filtered.rows[idx];
                                    
                                        // BayerChangeoverTimesDataShape entry object
                                        let newEntry = new Object();
                                        newEntry.startTime = row.startTime; // DATETIME
                                        newEntry.endTime = row.endTime; // DATETIME
                                        newEntry.targetTime = row.targetHours * 60; // INTEGER
                                        newEntry.actualTime = Math.round(dateDifference(row.status == "INPROGRESS" ? currentTime : row.endTime, row.startTime) / 1000 / 60); // INTEGER
                                        newEntry.difference = newEntry.actualTime - newEntry.targetTime; // INTEGER
                                        result.AddRow(newEntry);
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetChangeoverTrendByDate">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var result = Things["BayerDBDataProvider"].GetChangeoverTrendByDate({
                                    	endDate: endDate,
                                    	line: me.name,
                                    	startDate: startDate
                                    });
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetChangeoverTrendForLine">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var result =  Things["BayerDBDataProvider"].GetChangeoverTrendForLine({
                                        productionLine: me.name,
                                        dateTime: dateTime,
                                        week: week,
                                    });
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetCurrentProduct">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // GetCurrentProduct service
                                    
                                    var result = null;
                                    if (me.currentProductKey) {
                                        try {
                                            // result: INFOTABLE dataShape: "BayerProductionPlanDataShape"
                                            result = Things["BayerDBDataProvider"].GetProductionPlan({
                                                id: me.currentProductKey /* INTEGER */
                                            });
                                        }
                                        catch (ex) {
                                            logger.error(me.name + ".GetCurrentProduct() " + ex);
                                        }
                                    }
                                    
                                    if (!result || result.rows.length === 0) {
                                        // result: INFOTABLE dataShape: "BayerProductionPlanDataShape"
                                        result = Things["BayerDBDataProvider"].GetProductionPlanItemByStatus({
                                            productionLine: me.name /* THINGNAME */,
                                            status: 'INPROGRESS' /* STRING */
                                        });
                                    
                                        if (result && result.rows.length > 0) {
                                            me.currentProductKey = result.id;
                                        } else {
                                            // CreateInfoTableFromDataShape(infoTableName:STRING("InfoTable"), dataShapeName:STRING):INFOTABLE(BayerProductionPlanDataShape)
                                            result = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                                dataShapeName: "BayerProductionPlanDataShape"
                                            });
                                        }
                                    }
                                    
                                    if (result && result.rows.length > 0) {
                                        // result: STRING
                                        result.productDescription = Things["BayerUtilities"].GetProductDescriptionTranslated({
                                            productId: result.productId /* STRING */,
                                            productDescription: result.productDescription /* STRING */
                                        });
                                        if (!result.blistersPerFoldedBox)
                                            result.blistersPerFoldedBox = 1; //! fallback
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetMaintenanceTicketsByDate">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var result =  Things["BayerDBDataProvider"].GetMaintenanceTicketsByDate({
                                    	endDate: endDate,
                                    	productionLine: me.name,
                                    	startDate: startDate
                                    });
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="GetProductionPlan">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // GetProductionPlan service
                                    
                                    // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                    var result =  Things["BayerDBDataProvider"].GetProductionPlanForLine({
                                    	line: me.name /* THINGNAME */
                                    });
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="InsertStandbyBelow">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // InsertStandbyBelow service
                                    // * afterProductionId - INTEGER
                                    // * targetHours - NUMBER
                                    
                                    var dbDataProvider = Things["BayerDBDataProvider"];
                                    
                                    function addStandby(targetHours) {
                                        var singleRecord = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                            infoTableName: "result" /* STRING */,
                                            dataShapeName: "BayerProductionPlanDataShape" /* DATASHAPENAME */
                                        });
                                        // BayerProductionPlanDataShape entry object
                                        var newEntry = {};
                                        newEntry.productId = "standby"; // STRING
                                        newEntry.productionLine = me.name; // THINGNAME - isPrimaryKey = true
                                        newEntry.producedQuantity = 0; // NUMBER
                                        newEntry.startTime = undefined; // DATETIME
                                        newEntry.endTime = undefined; // DATETIME
                                        newEntry.workedHours = 0; // NUMBER
                                        newEntry.orderNr = ""; // STRING
                                        newEntry.productDescription = "No scheduled production"; // STRING
                                        newEntry.targetQuantity = 0; // NUMBER
                                        newEntry.targetQuantityPerHour = 0; // NUMBER
                                        newEntry.status = "PENDING"; // STRING
                                        newEntry.targetHours = targetHours; // 7 days
                                        newEntry.remainingHours = newEntry.targetHours; // NUMBER
                                        singleRecord.AddRow(newEntry);
                                        var insertedMap = dbDataProvider.AddProductionPlanItems({
                                            items: singleRecord /* INFOTABLE */
                                        });
                                        return insertedMap.rows[0].id;
                                    } // addStandby(...)
                                    
                                    try {
                                    
                                        // result: INFOTABLE dataShape: "BayerProductionPlanDataShape"
                                        var affectedProdItems = dbDataProvider.GetProductionPlanForLine({
                                            line: me.name /* THINGNAME */
                                        });
                                    
                                        var numRows = affectedProdItems.rows.length;
                                        var oldNumRows = numRows;
                                        for (let idx = 0; idx < numRows; idx++) {
                                            let row = affectedProdItems.rows[idx];
                                            if (row.id <= afterProductionId || row.status != "PENDING") {
                                                affectedProdItems.RemoveRow(idx);
                                                idx--;
                                                numRows--;
                                            }
                                        } // for each row
                                        logger.debug(me.name + ": InsertStandbyBelow: affectedProdItems oldCount=" + oldNumRows + " newCount=" + numRows);
                                        /* before inserting standby record need to check
                                           if the following record is not a standby
                                        */
                                        var productDescriptionValue = affectedProdItems.rows[0].productDescription;
                                    
                                        if (productDescriptionValue != "standby") {
                                            // before duplicating list of affected items
                                            // need to insert the actual standby record
                                            var standbyId = addStandby(targetHours);
                                            logger.debug(me.name + ": InsertStandbyBelow: inserted standby with id=" + standbyId);
                                            // id / oldId
                                            var prodItemsMapping = dbDataProvider.AddProductionPlanItems({
                                                items: affectedProdItems /* INFOTABLE */
                                            });
                                            var numMappings = prodItemsMapping.rows.length;
                                            logger.debug(me.name + ": InsertStandbyBelow: numMappings=" + numMappings);
                                    
                                            for (let idx = 0; idx < numMappings; idx++) {
                                                let mapped = prodItemsMapping.rows[idx];
                                                if (!mapped.oldId) {
                                                    continue; // just in case
                                                }
                                                dbDataProvider.UpdateShiftScheduleItem({
                                                    oldProductionPlanId: mapped.oldId /* INTEGER */,
                                                    newProductionPlanId: mapped.id /* INTEGER */
                                                });
                                            } // for each inserted row map
                                    
                                            for (let idx = 0; idx < numMappings; idx++) {
                                                let mapped = prodItemsMapping.rows[idx];
                                                if (!mapped.oldId) {
                                                    continue; // just in case
                                                }
                                                dbDataProvider.DeleteFromProductionPlan({
                                                    id: mapped.oldId /* INTEGER */
                                                });
                                                // in result -> show new prod plan id!
                                                affectedProdItems.rows[idx].id = mapped.id;
                                            } // for each inserted row map
                                    
                                            var result = affectedProdItems; // ids changed
                                        } else {
                                            var params = {
                                                infoTableName: "InfoTable",
                                                dataShapeName: "BayerProductionPlanDataShape"
                                            };
                                            // CreateInfoTableFromDataShape(infoTableName:STRING("InfoTable"), dataShapeName:STRING):INFOTABLE(BayerProductionPlanDataShape)
                                            var result = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape(params);
                                        }
                                    } catch (ex) {
                                        logger.error(me.name + ": Error: " + ex + " " + ex.stack);
                                        throw ex;
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="LoadCSVv2">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var lineConfig = me.GetLineConfiguration();
                                    
                                    // result: INFOTABLE
                                    var data = Things["BayerUtilities"].LoadCSVGeneric({ delimiter: ";" /* STRING */, filePath: path /* STRING */, repository: repository /* THINGNAME */ });
                                    
                                    // CreateInfoTableFromDataShape(infoTableName:STRING("InfoTable"), dataShapeName:STRING):INFOTABLE(BayerProductionPlanDataShape)
                                    var result = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({ dataShapeName : "BayerProductionPlanDataShape" });
                                    
                                    // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                    var lastItem =  Things["BayerDBDataProvider"].GetLastProductionPlanItem({
                                    	line: me.name /* THINGNAME */
                                    });
                                    var prev = lastItem.rows.length > 0 ? lastItem.rows[0] : undefined;
                                    
                                    var tableLength = data.rows.length;
                                    for (var x = 0; x < tableLength; x++) {
                                    	var row = data.rows[x];
                                        
                                        try {
                                            // BayerProductionPlanDataShape entry object
                                            var newEntry = new Object();
                                            newEntry.productId = row["Product Number"]; // STRING
                                            if(isNaN(parseInt(newEntry.productId))) {
                                                logger.debug(me.name + ".LoadCSVv2: Skipping row " + x + "; product id " + newEntry.productId);
                                                continue;
                                            }
                                            
                                            newEntry.orderNr = row["Order Number"]; // STRING
                                            newEntry.productDescription = row["Product Description"]; // STRING
                                            newEntry.version = row["Version (Batch)"]; // STRING
                                            newEntry.targetQuantity = parseFloat(row["Operation Quantity"].replace(',', '.').replace(' ', '')); // NUMBER
                                            newEntry.uom = row["Unit of operation qty"];
                                            newEntry.activeMaterialNumber = row["Ingredient product number"];
                                            newEntry.commentFirstLine = row["Comment 1st line"];
                                            newEntry.blisterType = row["Blister  LxW"];
                                            newEntry.foldedBoxFormat = row["Folded box LxHxW"];
                                            newEntry.blistersPerFoldedBox = parseInt(row["Blisters per folded box"]);
                                            
                                            try {
                                            	newEntry.mdatSaf = parseDate(row["MDAT-SAF: Safety Days of Supply Date"], "yyyy-MM-dd");
                                            }
                                            catch (dateParseEx) {
                                                logger.warn(me.name + ".LoadCSVv2 error parsing MDAT-SAF date. Value: " + row["MDAT-SAF: Safety Days of Supply Date"]);
                                            }
                                            
                                            try {
                                            	newEntry.mdatOos = parseDate(row["MDAT-OOS: Real Out of Stock Date"], "yyyy-MM-dd");
                                            }
                                            catch (dateParseEx) {
                                                logger.warn(me.name + ".LoadCSVv2 error parsing MDAT-OOS date. Value: " + row["MDAT-OOS: Real Out of Stock Date"]);
                                            }
                                            
                                            newEntry.tabletsPerBlister = parseInt(row["Tablets per Blister"]);
                                            newEntry.manufProcess = row["Manufact. Process"];
                                    
                                            newEntry.targetQuantityPerHour = Things["BayerMaterialPerformanceTable"].GetNominalRate({code: newEntry.productId, productionLine: me.name}) * lineConfig.nominalRateCorrection; // NUMBER
                                            if (!newEntry.targetQuantityPerHour) {
                                                logger.warn(me.name + ": no NominalRate for product " + newEntry.productId + ". Setting default 60 PCE per hour.");
                                                newEntry.targetQuantityPerHour = 60;
                                            }
                                            newEntry.targetQuantityPerHour = Math.round(newEntry.targetQuantityPerHour);
                                    
                                            newEntry.targetHours = Math.round(newEntry.targetQuantity / newEntry.targetQuantityPerHour * 100) / 100; // NUMBER
                                            newEntry.remainingHours = newEntry.targetHours; // NUMBER
                                            newEntry.productionLine = me.name; // THINGNAME - isPrimaryKey = true
                                            newEntry.producedQuantity = 0; // NUMBER
                                            newEntry.startTime = undefined; // DATETIME
                                            newEntry.endTime = undefined; // DATETIME
                                            newEntry.workedHours = 0; // NUMBER
                                            newEntry.status = "PENDING"; // STRING
                                    
                                            if (prev) {
                                                result.AddRow(getChangeover(prev, newEntry));
                                            }
                                    
                                            prev = newEntry;
                                    
                                            result.AddRow(newEntry);
                                        }
                                        catch (ex) {
                                            logger.error(me.name + ".LoadCSVv2 error parsing row " + x + ": " + ex);
                                        }
                                    }
                                    
                                    Things["BayerDBDataProvider"].AddProductionPlanItems({
                                    	items: result /* INFOTABLE */
                                    });
                                    
                                    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                    
                                    function getChangeover(prevItem, newItem) {
                                        // BayerProductionPlanDataShape entry object
                                        var newEntry = new Object();
                                        newEntry.productId = "Cambio"; // STRING
                                        newEntry.productionLine = me.name; // THINGNAME - isPrimaryKey = true
                                        newEntry.producedQuantity = 0; // NUMBER
                                        newEntry.startTime = undefined; // DATETIME
                                        newEntry.endTime = undefined; // DATETIME
                                        newEntry.workedHours = 0; // NUMBER
                                        newEntry.orderNr = ""; // STRING
                                        newEntry.productDescription = "Cambio"; // STRING
                                        newEntry.targetQuantity = 0; // NUMBER
                                        newEntry.targetQuantityPerHour = 0; // NUMBER
                                        newEntry.status = "PENDING"; // STRING
                                    
                                        // result: INTEGER
                                        var activeMaterialTime = Things["BayerChangeoverTimeMatrix_ActiveMaterial"].GetChangeoverTime({
                                            sourceCode: prevItem.activeMaterialNumber /* STRING */,
                                            productionLine: me.name /* THINGNAME */,
                                            targetCode: newItem.activeMaterialNumber /* STRING */
                                        });
                                    
                                        // result: INTEGER
                                        var blisterTime = Things["BayerChangeoverTimeMatrix_BlisterType"].GetChangeoverTime({
                                            sourceCode: prevItem.blisterType /* STRING */,
                                            productionLine: me.name /* THINGNAME */,
                                            targetCode: newItem.blisterType /* STRING */
                                        });
                                    
                                        // result: INTEGER
                                        var fbTime = Things["BayerChangeoverTimeMatrix_FB"].GetChangeoverTime({ 
                                            sourceCode: prevItem.foldedBoxFormat /* STRING */,
                                            productionLine: me.name /* THINGNAME */,
                                            targetCode: newItem.foldedBoxFormat /* STRING */
                                        });
                                    
                                        newEntry.targetHours = (Math.max(activeMaterialTime, blisterTime, fbTime) + lineConfig.additionalChangeoverTime) / 60;
                                        newEntry.targetHours = Math.round(newEntry.targetHours * 100) / 100;
                                        newEntry.remainingHours = newEntry.targetHours; // NUMBER
                                        
                                        return newEntry;
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="LoadProductionPlan">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // LoadProductionPlan service
                                    // > BayerProductionManagement Thing Shape (Main Implementation)
                                    // * data - INFOTABLE
                                    // * simulate - BOOLEAN
                                    if (!simulate) {
                                        simulate = false;
                                    }
                                    if (!data) {
                                        throw new Error("Invalid input - missing 'data' InfoTable (required)!");
                                    }
                                    var numDataRows = data.rows.length;
                                    var SERVICE_NAME = "LoadPlan(Base)";
                                    var lineConfig = me.GetLineConfiguration();
                                    var changeoverCalculationThingName = lineConfig.changeoverCalculationThing;
                                    var changeoverCalculationThing = null;
                                    if (!!changeoverCalculationThingName) {
                                        changeoverCalculationThing = Things[changeoverCalculationThingName];
                                    }
                                    var completedPlan = me.GetProductionPlan();
                                    var runningPlan = Resources["InfoTableFunctions"].Clone({ t1: completedPlan });
                                    completedPlan.Filter({ status: "COMPLETED" });
                                    runningPlan.Filter({ status: "INPROGRESS" });
                                    if (!!runningPlan.rows.length) {
                                        completedPlan.AddRow(runningPlan.rows[0]);
                                    }
                                    var numCompletedItems = completedPlan.rows.length;
                                    // CreateInfoTableFromDataShape(infoTableName:STRING("InfoTable"), dataShapeName:STRING):INFOTABLE(BayerProductionPlanDataShape)
                                    var result = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                        dataShapeName: "BayerProductionPlanDataShape"
                                    });
                                    if (!simulate) {
                                        Things["BayerDBDataProvider"].DeleteScheduledProduction({
                                            productionLine: me.name /* THINGNAME */
                                        });
                                    }
                                    if (data.rows.length === 1 && data.productId === 'standby') {
                                        addStandby();
                                    } else {
                                        processInputData();
                                    }
                                    if (!simulate) {
                                        Things["BayerDBDataProvider"].AddProductionPlanItems({
                                            items: result /* INFOTABLE */
                                        });
                                        me.lastProductionPlanUpdate = new Date();
                                        INFO("Production Plan Loaded: OK (countInputRows=" + numDataRows + ")");
                                    } else {
                                        INFO("Production Plan Loaded: OK (simulated)");
                                    }
                                    //>----------------------------------------------------------------------------
                                    
                                    function addStandby() {
                                        // BayerProductionPlanDataShape entry object
                                        let newEntry = {};
                                        newEntry.productId = "standby"; // STRING
                                        newEntry.productionLine = me.name; // THINGNAME - isPrimaryKey = true
                                        newEntry.producedQuantity = 0; // NUMBER
                                        newEntry.startTime = undefined; // DATETIME
                                        newEntry.endTime = undefined; // DATETIME
                                        newEntry.workedHours = 0; // NUMBER
                                        newEntry.orderNr = ""; // STRING
                                        newEntry.productDescription = "No scheduled production"; // STRING
                                        newEntry.targetQuantity = 0; // NUMBER
                                        newEntry.targetQuantityPerHour = 0; // NUMBER
                                        newEntry.status = "PENDING"; // STRING
                                        newEntry.targetHours = 168; // 7 days
                                        newEntry.remainingHours = newEntry.targetHours; // NUMBER
                                        result.AddRow(newEntry);
                                    } //> addStandby()
                                    //>----------------------------------------------------------------------------
                                    
                                    function processInputData() {
                                        // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                        let lastItem = Things["BayerDBDataProvider"].GetLastProductionPlanItem({
                                            line: me.name /* THINGNAME */
                                        });
                                        let prev = lastItem.rows.length > 0 ? lastItem.rows[0] : undefined;
                                        let tableLength = data.rows.length;
                                        for (let idx = 0; idx < tableLength; idx++) {
                                            let row = data.rows[idx];
                                            try {
                                                // BayerProductionPlanDataShape entry object
                                                let newEntry = {};
                                                newEntry.productionLine = me.name; // THINGNAME - isPrimaryKey = true
                                                newEntry.status = "PENDING"; // STRING
                                                //? Check if the production plan item is already marked as complete
                                                let existingItem = completedPlan.Find({
                                                    productId: row.productId,
                                                    orderNr: row.orderNr,
                                                    productDescription: row.productDescription
                                                });
                                                if (!!existingItem) {
                                                    // found? skip?
                                                    DEBUG("Skipping row " + idx + "; product id '" + row.productId + "'; Already produced.");
                                                    continue;
                                                }
                                                //!---------------- FROM FILE -----------------
                                                newEntry.productId = row.productId; // STRING
                                                if (isNaN(parseInt(newEntry.productId))) {
                                                    DEBUG("Skipping row " + idx + "; product id '" + row.productId + "'; Wrong productId.");
                                                    continue;
                                                }
                                                newEntry.taNumber = row.taNumber; // STRING
                                                newEntry.orderNr = row.orderNr; // STRING
                                                if (!newEntry.orderNr ||
                                                    newEntry.orderNr.indexOf("=") != -1 ||
                                                    newEntry.orderNr.indexOf("#") != -1 ||
                                                    newEntry.orderNr.indexOf("-") != -1) {
                                                    continue;
                                                }
                                                newEntry.productDescription = row.productDescription; // STRING
                                                newEntry.version = row.version; // STRING
                                                newEntry.targetQuantity = parseFloat(row.targetQuantity.replace(',', '.').replace(' ', '')); // NUMBER
                                                newEntry.uom = row.uom;
                                                newEntry.activeMaterialNumber = row.activeMaterialNumber;
                                                newEntry.commentFirstLine = row.commentFirstLine;
                                                newEntry.blisterType = row.blisterType;
                                                newEntry.foldedBoxFormat = row.foldedBoxFormat;
                                                newEntry.blistersPerFoldedBox = parseIntSafe(row.blistersPerFoldedBox);
                                                if (row.mdatSaf != undefined) {
                                                    try {
                                                        newEntry.mdatSaf = parseDate(row.mdatSaf, "yyyy-MM-dd");
                                                    } catch (dateParseEx) {
                                                        WARNING("Error parsing MDAT-SAF date. Value: " + row.mdatSaf);
                                                    }
                                                }
                                                if (row.mdatOos != undefined) {
                                                    try {
                                                        newEntry.mdatOos = parseDate(row.mdatOos, "yyyy-MM-dd");
                                                    } catch (dateParseEx) {
                                                        WARNING("Error parsing MDAT-OOS date. Value: " + row.mdatOos);
                                                    }
                                                }
                                                newEntry.tabletsPerBlister = parseIntSafe(row.tabletsPerBlister);
                                                newEntry.manufProcess = row.manufProcess;
                                                //!---------------- CALCULATED ----------------
                                                let blitersPerBoxCorrection = 1;
                                                if (lineConfig.nominalRateInBlisters) {
                                                    if (newEntry.blistersPerFoldedBox) {
                                                        blitersPerBoxCorrection = newEntry.blistersPerFoldedBox;
                                                    } else {
                                                        ERROR("Error: nominalRateInBlisters but no blistersPerFoldedBox provided");
                                                        newEntry.blistersPerFoldedBox = 1; //! fallback
                                                    }
                                                }
                                                newEntry.targetQuantityPerHour = (Things["BayerMaterialPerformanceTable"].GetNominalRate({
                                                    code: newEntry.productId,
                                                    productionLine: me.name
                                                }) / blitersPerBoxCorrection) * lineConfig.nominalRateCorrection; // NUMBER
                                                if (!newEntry.targetQuantityPerHour) {
                                                    WARNING("No 'NominalRate' for product " + newEntry.productId + ". Setting default 60 PCE per hour.");
                                                    newEntry.targetQuantityPerHour = 60;
                                                }
                                                newEntry.targetQuantityPerHour = Math.round(newEntry.targetQuantityPerHour);
                                                newEntry.targetHours = Math.round(newEntry.targetQuantity / newEntry.targetQuantityPerHour * 100) / 100; // NUMBER
                                                newEntry.remainingHours = newEntry.targetHours; // NUMBER
                                                newEntry.producedQuantity = 0; // NUMBER
                                                newEntry.startTime = undefined; // DATETIME
                                                newEntry.endTime = undefined; // DATETIME
                                                newEntry.workedHours = 0; // NUMBER
                                                newEntry.changeoverTime = row.changeoverTime; // might be undefined
                                                if (prev && newEntry.productId != 'standby') {
                                                    let changeoverItem = getChangeover(prev, newEntry);
                                                    //DEBUG("Changeover time: '" + changeoverItem.targetHours + "' for prev='" + prev.taNumber + "' next='" + newEntry.taNumber + "'");
                                                    result.AddRow(changeoverItem);
                                                }
                                                if (newEntry.productId != 'standby') {
                                                    prev = newEntry;
                                                }
                                                DEBUG("Row nr: " + idx + ": " + JSON.stringify(newEntry));
                                                result.AddRow(newEntry);
                                            } catch (ex) {
                                                ERROR("Error parsing row " + idx + ": " + ex + " " + ex.stack);
                                            }
                                        } //# for each input data row
                                        //#DEBUG("Content: " + JSON.stringify(result.ToJSON()));
                                    } //> processInputData()
                                    //>----------------------------------------------------------------------------
                                    
                                    function getChangeover(prevItem, nextItem) {
                                        let changeoverItem = undefined;
                                        if (!!changeoverCalculationThing && !nextItem.changeoverTime) {
                                            try {
                                                changeoverItem = changeoverCalculationThing.GetChangeoverPlanItem({
                                                    prevItem: prevItem,
                                                    nextItem: nextItem,
                                                    productionLine: me.name
                                                });
                                            } catch (ex) {
                                                ERROR("Changeover exception prev='" + (prevItem.taNumber || prevItem.productId) +
                                                    "' next='" + (nextItem.taNumber || nextItem.productId) + "': " + ex + " " + ex.stack);
                                                changeoverItem = undefined;
                                            }
                                        }
                                        if (!changeoverCalculationThing || !changeoverItem) {
                                            DEBUG("Changeover time calculated with OLD method for prev='" + (prevItem.taNumber || prevItem.productId) +
                                                "' next='" + (nextItem.taNumber || nextItem.productId) + "'");
                                            changeoverItem = getChangeoverFallback(prevItem, nextItem);
                                        }
                                        return changeoverItem;
                                    } //> getChangeover(...)
                                    //>----------------------------------------------------------------------------
                                    
                                    function getChangeoverFallback(prevItem, newItem) {
                                        // BayerProductionPlanDataShape entry object
                                        let newEntry = {};
                                        newEntry.productId = "Cambio"; // STRING
                                        newEntry.productionLine = me.name; // THINGNAME - isPrimaryKey = true
                                        newEntry.producedQuantity = 0; // NUMBER
                                        newEntry.startTime = undefined; // DATETIME
                                        newEntry.endTime = undefined; // DATETIME
                                        newEntry.workedHours = 0; // NUMBER
                                        newEntry.orderNr = ""; // STRING
                                        newEntry.productDescription = "Cambio"; // STRING
                                        newEntry.targetQuantity = 0; // NUMBER
                                        newEntry.targetQuantityPerHour = 0; // NUMBER
                                        newEntry.status = "PENDING"; // STRING
                                        if (!newItem.changeoverTime) {
                                            // result: INTEGER
                                            let activeMaterialTime = Things["BayerChangeoverTimeMatrix_ActiveMaterial"].GetChangeoverTime({
                                                sourceCode: prevItem.activeMaterialNumber /* STRING */,
                                                productionLine: me.name /* THINGNAME */,
                                                targetCode: newItem.activeMaterialNumber /* STRING */
                                            });
                                            // result: INTEGER
                                            let blisterTime = Things["BayerChangeoverTimeMatrix_BlisterType"].GetChangeoverTime({
                                                sourceCode: prevItem.blisterType /* STRING */,
                                                productionLine: me.name /* THINGNAME */,
                                                targetCode: newItem.blisterType /* STRING */
                                            });
                                            // result: INTEGER
                                            let fbTime = Things["BayerChangeoverTimeMatrix_FB"].GetChangeoverTime({
                                                sourceCode: prevItem.foldedBoxFormat /* STRING */,
                                                productionLine: me.name /* THINGNAME */,
                                                targetCode: newItem.foldedBoxFormat /* STRING */
                                            });
                                            newEntry.targetHours = (Math.max(activeMaterialTime, blisterTime, fbTime) + lineConfig.additionalChangeoverTime) / 60;
                                        } else {
                                            // default fallback - changeover time is coming from the production plan
                                            newEntry.targetHours = parseFloat(newItem.changeoverTime + "") + lineConfig.additionalChangeoverTime / 60.0;
                                            delete newItem.changeoverTime;
                                        }
                                        if (isNaN(newEntry.targetHours) || !isFinite(newEntry.targetHours))
                                            newEntry.targetHours = lineConfig.additionalChangeoverTime;
                                        if (!newEntry.targetHours)
                                            newEntry.targetHours = 0.0;
                                        newEntry.targetHours = Math.round(newEntry.targetHours * 100) / 100;
                                        newEntry.remainingHours = newEntry.targetHours; // NUMBER
                                        return newEntry;
                                    } //> getChangeover(...)
                                    //>----------------------------------------------------------------------------
                                    
                                    function parseIntSafe(value) {
                                        let parsedVal = parseInt(value);
                                        return isNaN(parsedVal) ? undefined : parsedVal;
                                    } //> parseIntSafe(...)
                                    //>----------------------------------------------------------------------------
                                    
                                    function DEBUG(message) {
                                        logger.debug(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> DEBUG
                                    
                                    function TRACE(message) {
                                        logger.trace(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> TRACE
                                    
                                    function ERROR(message) {
                                        logger.error(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> ERROR
                                    
                                    function WARNING(message) {
                                        logger.warn(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> WARNING
                                    
                                    function INFO(message) {
                                        logger.info(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> INFO
                                    //>----------------------------------------------------------------------------
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="RecalculatePlanChangeovers">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // RecalculatePlanChangeovers service
                                    // * simulate - BOOLEAN
                                    
                                    var SERVICE_NAME = "RecalculatePlanChangeovers";
                                    var lineConfig = me.GetLineConfiguration();
                                    var changeoverCalculationThingName = lineConfig.changeoverCalculationThing;
                                    if (!changeoverCalculationThingName) {
                                        changeoverCalculationThingName = "BayerChangeoverDefaultCalculationThing";
                                    }
                                    var changeoverCalculationThing = null;
                                    if (!!changeoverCalculationThingName) {
                                        changeoverCalculationThing = Things[changeoverCalculationThingName];
                                    }
                                    var dataProvider = Things["BayerDBDataProvider"];
                                    //var productionPlan = me.GetProductionPlan();
                                    var productionPlan = dataProvider.GetProductionPlanForLineOrderByOrderSequenceNumber({
                                    	line: me.name /* THINGNAME */
                                    });
                                    
                                    productionPlan.Delete({ status: "COMPLETED" });
                                    var numRows = productionPlan.rows.length;
                                    var changeover = null, prev = null, next = null;
                                    for (let idx = 0; idx < numRows; idx++) {
                                        let current = productionPlan.rows[idx];
                                        if (!idx && (current.productId == 'Cambio' || current.productId == 'stanby')) {
                                            continue; // skip!
                                        }
                                        let isProductLike = (current.productId != 'Cambio' && current.productId != 'standby');
                                        let isChangeover = (current.productId == 'Cambio');
                                        if (!prev && isProductLike) {
                                            changeover = null;
                                            prev = current;
                                        } else if (!!prev && !changeover && !next && isChangeover) {
                                            changeover = current;
                                        } else if (!next && isProductLike) {
                                            next = current;
                                        }
                                        if (!!prev && !!changeover && !!next) {
                                            let beforeHours = changeover.targetHours;
                                            let afterHours = changeoverCalculationThing.GetChangeoverTime({
                                                prevItem: prev,
                                                nextItem: next,
                                                productionLine: me.name
                                            });
                                            DEBUG("Changeover time: '" + afterHours + "' for prev='" + prev.taNumber +
                                                "' next='" + next.taNumber + "' id='" + changeover.id + "'");
                                            /*console.log("prev='" + prev.id + "' changeover='" + changeover.id +
                                                "' next='" + next.id + "' before='" + beforeHours +
                                                "' after='" + afterHours + "'");*/
                                            if (!simulate && !!changeover.id) {
                                                dataProvider.UpdateProductionPlanTargetHours({
                                                    id: changeover.id,
                                                    targetHours: afterHours
                                                });
                                            }
                                            changeover.targetHours = afterHours;
                                            changeover.remainingHours = afterHours;
                                            changeover = null;
                                            prev = next;
                                            next = null;
                                        }
                                    } //# for each production plan row
                                    var result = productionPlan;
                                    //>----------------------------------------------------------------------------
                                    
                                    function DEBUG(message) {
                                        logger.debug(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> DEBUG
                                    
                                    function TRACE(message) {
                                        logger.trace(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> TRACE
                                    
                                    function ERROR(message) {
                                        logger.error(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> ERROR
                                    
                                    function WARNING(message) {
                                        logger.warn(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> WARNING
                                    
                                    function INFO(message) {
                                        logger.info(me.name + ":" + SERVICE_NAME + ": " + message);
                                    } //> INFO
                                    //>----------------------------------------------------------------------------
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="SetChangeoverSplitTimes">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    // 
                                    // SetChangeoverSplitTimes service
                                    // * splitTimes - INFOTABLE
                                    
                                    var output = Resources["InfoTableFunctions"].CreateInfoTableFromDataShape({
                                        infoTableName: "result" /* STRING */,
                                        dataShapeName: "BayerChangeoversSplitTimeDelays" /* DATASHAPENAME */
                                    });
                                    var result = output;
                                    var entry = {};
                                    var fields = output.dataShape.fields;
                                    var numRows = 0;
                                    if(!!splitTimes && !!splitTimes.rows) {
                                        numRows = splitTimes.rows.length;
                                    }
                                    for(let idx=0; idx<numRows; idx++) {
                                        let row = splitTimes.rows[idx];
                                        if(!fields[row.fieldName]) {
                                            continue; // skip!
                                        }
                                        entry[row.fieldName] = row.value;
                                    } //# for each input row
                                    output.AddRow(entry);
                                    
                                    if(!!updateTable) {
                                        me.SetConfigurationTable({
                                            tableName: "Changeover_SplitTimes", // STRING - Configuration table name
                                            configurationTable: output, // INFOTABLE - Configuration table content
                                            persistent: true, // BOOLEAN - Persist these changes
                                        });
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="UpdateCounter">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var incomingValue = eventData.newValue.value;
                                    
                                    if (me.previousProductCounter <= incomingValue) {
                                        me.counter = incomingValue - me.previousProductCounter;
                                    }
                                    else {
                                        me.previousProductCounter = 0;
                                        me.counter = incomingValue;
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="UpdateProduct">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description="Script"
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    //
                                    // UpdateProduct service
                                    
                                    if (!me.updateProductLock) {
                                        // result: INFOTABLE dataShape: "BayerProductionPlanDbDataShape"
                                        var currentProduct = me.GetCurrentProduct();
                                    
                                        if (!!currentProduct && !!currentProduct.rows.length) {
                                            // dateDifference(date1:DATETIME,date2:DATETIME):NUMBER
                                            var difference = dateDifference(eventData.timestamp, currentProduct.startTime);
                                    
                                            currentProduct.workedHours = difference / 1000.0 / 60.0 / 60.0;
                                            currentProduct.remainingHours = currentProduct.targetHours - currentProduct.workedHours;
                                            if (currentProduct.remainingHours < 0) {
                                                currentProduct.remainingHours = 0;
                                            }
                                    
                                            Things["BayerDBDataProvider"].UpdateProductionPlanHours({
                                                data: currentProduct /* INFOTABLE */
                                            });
                                        }
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
                <ServiceImplementation
                 description=""
                 handlerName="Script"
                 name="UpdateRejectCounter">
                    <ConfigurationTables>
                        <ConfigurationTable
                         description=""
                         isMultiRow="false"
                         name="Script"
                         ordinal="0">
                            <DataShape>
                                <FieldDefinitions>
                                    <FieldDefinition
                                     baseType="STRING"
                                     description="code"
                                     name="code"
                                     ordinal="0"></FieldDefinition>
                                </FieldDefinitions>
                            </DataShape>
                            <Rows>
                                <Row>
                                    <code>
                                    <![CDATA[
                                    var incomingValue = eventData.newValue.value;
                                    
                                    if (me.previousProductRejectCounter <= incomingValue) {
                                        me.rejectCounter = incomingValue - me.previousProductRejectCounter;
                                    }
                                    else {
                                        me.previousProductRejectCounter = 0;
                                        me.rejectCounter = incomingValue;
                                    }
                                    ]]>
                                    </code>
                                </Row>
                            </Rows>
                        </ConfigurationTable>
                    </ConfigurationTables>
                </ServiceImplementation>
            </ServiceImplementations>
            <Subscriptions>
                <Subscription
                 description=""
                 enabled="true"
                 eventName="DataChange"
                 name="OnKepwareCounterChanged"
                 source=""
                 sourceProperty="kepwareCounter"
                 sourceType="Thing">
                    <ServiceImplementation
                     description=""
                     handlerName="Script"
                     name="OnKepwareCounterChanged">
                        <ConfigurationTables>
                            <ConfigurationTable
                             description=""
                             isMultiRow="false"
                             name="Script"
                             ordinal="0">
                                <DataShape>
                                    <FieldDefinitions>
                                        <FieldDefinition
                                         baseType="STRING"
                                         description="code"
                                         name="code"
                                         ordinal="0"></FieldDefinition>
                                    </FieldDefinitions>
                                </DataShape>
                                <Rows>
                                    <Row>
                                        <code>
                                        <![CDATA[
                                        var params = {
                                        	eventData: eventData /* INFOTABLE */
                                        };
                                        
                                        me.UpdateCounter(params);
                                        ]]>
                                        </code>
                                    </Row>
                                </Rows>
                            </ConfigurationTable>
                        </ConfigurationTables>
                    </ServiceImplementation>
                </Subscription>
                <Subscription
                 description=""
                 enabled="true"
                 eventName="DataChange"
                 name="OnKepwareRejectCounterChanged"
                 source=""
                 sourceProperty="kepwareRejectCounter"
                 sourceType="Thing">
                    <ServiceImplementation
                     description=""
                     handlerName="Script"
                     name="OnKepwareRejectCounterChanged">
                        <ConfigurationTables>
                            <ConfigurationTable
                             description=""
                             isMultiRow="false"
                             name="Script"
                             ordinal="0">
                                <DataShape>
                                    <FieldDefinitions>
                                        <FieldDefinition
                                         baseType="STRING"
                                         description="code"
                                         name="code"
                                         ordinal="0"></FieldDefinition>
                                    </FieldDefinitions>
                                </DataShape>
                                <Rows>
                                    <Row>
                                        <code>
                                        <![CDATA[
                                        me.UpdateRejectCounter({
                                        	eventData: eventData /* INFOTABLE */
                                        });
                                        ]]>
                                        </code>
                                    </Row>
                                </Rows>
                            </ConfigurationTable>
                        </ConfigurationTables>
                    </ServiceImplementation>
                </Subscription>
            </Subscriptions>
            <avatar></avatar>
            <DesignTimePermissions>
                <Create></Create>
                <Read></Read>
                <Update></Update>
                <Delete></Delete>
                <Metadata></Metadata>
            </DesignTimePermissions>
            <RunTimePermissions></RunTimePermissions>
            <VisibilityPermissions>
                <Visibility>
                    <Principal
                     isPermitted="true"
                     name="Bayer:PerformanceDashboard"
                     type="OrganizationalUnit"></Principal>
                </Visibility>
            </VisibilityPermissions>
            <ConfigurationTableDefinitions></ConfigurationTableDefinitions>
            <ConfigurationTables></ConfigurationTables>
            <PropertyBindings></PropertyBindings>
            <RemotePropertyBindings></RemotePropertyBindings>
            <RemoteServiceBindings></RemoteServiceBindings>
            <RemoteEventBindings></RemoteEventBindings>
            <AlertConfigurations>
                <AlertDefinitions
                 name="counter"></AlertDefinitions>
                <AlertDefinitions
                 name="currentProductKey"></AlertDefinitions>
                <AlertDefinitions
                 name="kepwareCounter"></AlertDefinitions>
                <AlertDefinitions
                 name="kepwareRejectCounter"></AlertDefinitions>
                <AlertDefinitions
                 name="lastProductionPlanUpdate"></AlertDefinitions>
                <AlertDefinitions
                 name="previousProductCounter"></AlertDefinitions>
                <AlertDefinitions
                 name="previousProductRejectCounter"></AlertDefinitions>
                <AlertDefinitions
                 name="productionlinestatus"></AlertDefinitions>
                <AlertDefinitions
                 name="productionsensorvalue"></AlertDefinitions>
                <AlertDefinitions
                 name="rejectCounter"></AlertDefinitions>
                <AlertDefinitions
                 name="updateProductLock"></AlertDefinitions>
            </AlertConfigurations>
            <InstanceRunTimePermissions>
                <Permissions
                 resourceName="CompleteCurrentProduct">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="false"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetChangeoverTrendForLine">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetChangeoverTime">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="RecalculatePlanChangeovers">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="currentProductKey">
                    <PropertyRead>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </PropertyRead>
                    <PropertyWrite>
                        <Principal
                         isPermitted="false"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </PropertyWrite>
                    <ServiceInvoke></ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="UpdateProduct">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="lastProductionPlanUpdate">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite>
                        <Principal
                         isPermitted="true"
                         name="BayerProductionPlansProcessingUser"
                         type="User"></Principal>
                    </PropertyWrite>
                    <ServiceInvoke></ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="*">
                    <PropertyRead>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke></ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetCurrentProduct">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="BayerDelaysSystemUser"
                         type="User"></Principal>
                        <Principal
                         isPermitted="true"
                         name="BayerNotificationSystemUser"
                         type="User"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="counter">
                    <PropertyRead>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </PropertyRead>
                    <PropertyWrite>
                        <Principal
                         isPermitted="false"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </PropertyWrite>
                    <ServiceInvoke></ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetProductionPlan">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetChangeoverTrendByDate">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetChangeoverDetailsTrendForLine">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="updateProductLock">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </PropertyWrite>
                    <ServiceInvoke></ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="InsertStandbyBelow">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="LoadProductionPlan">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="BayerProductionPlansProcessingUser"
                         type="User"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="previousProductCounter">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </PropertyWrite>
                    <ServiceInvoke></ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetChangeoverTimes">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="SetChangeoverSplitTimes">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="UpdateCounter">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="System"
                         type="User"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetMaintenanceTicketsByDate">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerOffice"
                         type="Group"></Principal>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
                <Permissions
                 resourceName="GetChangeoverSplitTimes">
                    <PropertyRead></PropertyRead>
                    <PropertyWrite></PropertyWrite>
                    <ServiceInvoke>
                        <Principal
                         isPermitted="true"
                         name="Role.BayerProductionLine.Any"
                         type="Group"></Principal>
                    </ServiceInvoke>
                    <EventInvoke></EventInvoke>
                    <EventSubscribe></EventSubscribe>
                </Permissions>
            </InstanceRunTimePermissions>
        </ThingShape>
    </ThingShapes>
</Entities>
